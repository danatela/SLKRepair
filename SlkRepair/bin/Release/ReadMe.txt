Ремонт слк-файлов. (версия от 08.10.2010)

При работе с слк-файлами в Excel известна следующая проблема: когда количество стилей достигает определённого значения (>255), он либо некорректно отображается, либо (в особо тяжёлых случаях) его открытие приводит к краху Экселя. Особенно это заметно в Экселе из Офиса 2007, ибо, в отличие от своего предшественника, он каждый раз при сохранении записывает в документ новую копию таблицы стилей (записи вида P;F или P;E). Простая очистка заголовка документа от лишних записей не помогает, поскольку документ содержит ссылки на используемые стили. Для успешного исправления ошибок, выдаваемых Экселем при открытии "очищенных" документов, требуется эти ссылки корректно исправить.

Решение: программа SlkRepair выполняет черновую (UPD1: теперь почти всю) работу по исправлению документа. Она ищет используемые стили, записывает их в заголовок файла, и расставляет на них ссылки. Исправление осуществляется "на месте", старый документ копируется в бэкап с добавлением знака тильды (~) к имени файла. UPD1: Повторный запуск очистки заменит старый документ исправленным, так что, если по каким-либо причинам вам не понравился результат работы программы, позаботьтесь о том, чтобы старый документ был надлежащим образом сохранён.

Дополнительные функции: файл становится подготовлен к компиляции Випом, поскольку из него удаляются все пустые ячейки, которые не содержат обрамления. Необходимо компилировать такие слк в режиме совместимости со старой версией файла отчёта. UPD2: Удаляется также информация о высоте строк (записи, начинающиеся с "F;M"), поскольку она игнорируется випом при компиляции формы.

UPD1: Как использовать: slkrepair <список файлов> [/C[ONVERT]:(0|1|Y[ES]|N[O])].
Пример: slkrepair report.slk sklrep01.slk rep.slk /c:0
Естественно, файл приложения должен находиться в доступном месте, желательно объявленном в переменной среды PATH

UPD2 (07.10.10): Код реорганизован, произведены доработки: теперь программа декодирует длинные строки с закодированными русскими буквами, распознавая Escape-символы с кодом 27 и сохраняет их в кодировке ДОС (866). Декодирование включается командой /C[ONVERT]:1 и выключается той же командой с параметром 0: /C[ONVERT]:0. Чтобы включить или выключить режим конвертирования по умолчанию, необходимо отредактировать файл конфигурации приложения slkrepair.exe.config:
<?xml version="1.0"?>
<configuration>
...
<userSettings>
        <SlkRepair.Properties.Settings>
            <setting name="Convert" serializeAs="String">
			<!-- Конвертирование включается ниже -->
                <value>False</value>
            </setting>
        </SlkRepair.Properties.Settings>
    </userSettings>
</configuration>

Использованные материалы: список конструкций слк взят из Википедии (http://en.wikipedia.org/wiki/SYLK)